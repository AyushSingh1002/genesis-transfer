#!/bin/bash
# CI/CD wrapper for gradlew that ensures Capacitor is properly set up
# Use this script in CI/CD instead of gradlew directly

set -e

echo "ğŸ”§ CI/CD Gradle Wrapper - Preparing Capacitor Android build..."

# Ensure we're in the project root
if [ ! -f "capacitor.config.ts" ]; then
    echo "âŒ Error: capacitor.config.ts not found. Are you in the project root?"
    exit 1
fi

# Install npm dependencies if needed
if [ ! -d "node_modules" ] && [ -f "package.json" ]; then
    echo "ğŸ“¦ Installing npm dependencies..."
    if command -v npm >/dev/null 2>&1; then
        npm ci || npm install
    else
        echo "âŒ Error: npm not found"
        exit 1
    fi
fi

# Build web application if needed
if [ ! -d "dist" ] && [ -f "package.json" ]; then
    echo "ğŸ—ï¸ Building web application..."
    npm run build
fi

# Sync Capacitor Android
if command -v npx >/dev/null 2>&1; then
    echo "ğŸ”„ Syncing Capacitor Android..."
    npx cap sync android
    echo "ğŸ”„ Updating Capacitor Android..."
    npx cap update android
else
    echo "âŒ Error: npx not found"
    exit 1
fi

# Now run the actual gradle command
echo "ğŸš€ Running Android build..."
cd android
exec ./gradlew "$@"
